box: wercker-labs/docker
no-response-timeout: 30
build:
  steps:
    - script:
        name: install docker
        code: curl -sSL https://get.docker.com/ubuntu/ | sudo sh
    - script:
        name: print system-wide docker info
        code: |
          docker version
          docker info
          docker images
    - script:
        name: remove existing containers if necessary
        code: script/00_build_start.sh
    - script:
        name: build puppet agent base image
        code: script/01_build_puppetagent.sh
    - script:
        name: build fixtures image
        code: script/02_build_fixtures.sh
    - script:
        name: build dns server
        code: script/05_build_named.sh
    - script:
        name: build puppetdb
        code: script/10_build_puppetdb.sh
    - script:
        name: build puppetmaster
        code: script/10_build_puppetmaster.sh
    - script:
        name: build puppetboard
        code: script/15_build_puppetboard.sh
    - script:
        name: build autostager
        code: script/20_build_autostager.sh
    - script:
        name: run the test suite
        code: script/test
    - script:
        name: scan puppetagent for vulnerabilities
        code: |
          docker run --rm -t jumanjiman/puppetagent  /oval/vulnerability-scan.sh || :
    - script:
        name: scan puppetdb for vulnerabilities
        code: |
          docker run --rm -t jumanjiman/puppetdb     /oval/vulnerability-scan.sh || :
